


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xmen.monitor &mdash; xmen 0.2.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/jquery.fancybox.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/glpi.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="xmen 0.2.3 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> xmen
          

          
          </a>

          
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Xmen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class-api.html">Xmen Experiment Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cheat-sheet.html">Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xmen</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>xmen.monitor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xmen.monitor</h1><div class="highlight"><pre>
<span></span><span class="c1">#  Copyright (C) 2019  Robert J Weston, Oxford Robotics Institute</span>
<span class="c1">#  xmen</span>
<span class="c1">#  email:   robw@robots.ox.ac.uk</span>
<span class="c1">#  github: https://github.com/robw4/xmen/</span>
<span class="c1">#</span>
<span class="c1">#  This program is free software; you can redistribute it and/or modify</span>
<span class="c1">#  it under the terms of the GNU General Public License as published by</span>
<span class="c1">#  the Free Software Foundation; either version 3 of the License, or</span>
<span class="c1">#  (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#  This program is distributed in the hope that it will be useful,</span>
<span class="c1">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#  GNU General Public License for more details.</span>
<span class="c1">#  You should have received a copy of the GNU General Public License</span>
<span class="c1">#   along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">TRIGGERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;era&#39;</span><span class="p">,</span> <span class="s1">&#39;eon&#39;</span><span class="p">,</span> <span class="s1">&#39;supereon&#39;</span><span class="p">]</span>
<span class="n">BRIEF</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;era&quot;</span><span class="p">:</span> <span class="s2">&quot;er&quot;</span><span class="p">,</span> <span class="s2">&quot;eon&quot;</span><span class="p">:</span> <span class="s2">&quot;eo&quot;</span><span class="p">,</span> <span class="s2">&quot;supereon&quot;</span><span class="p">:</span> <span class="s2">&quot;se&quot;</span><span class="p">}</span>
<span class="n">IDX</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TRIGGERS</span><span class="p">)}</span>


<span class="k">class</span> <span class="nc">Spec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s1">&#39;invalid specification found&#39;</span>
        <span class="n">regex</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">trigger</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>
            <span class="n">regex</span><span class="p">,</span> <span class="n">string</span> <span class="o">=</span> <span class="n">parts</span>
            <span class="k">if</span> <span class="n">regex</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">regex</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[0-9]+&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;No steps found in </span><span class="si">{spec}</span><span class="s1">&#39;</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
            <span class="n">trigger</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">BRIEF</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">trigger</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                <span class="n">trigger</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">trig_key</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">steps</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trig_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">trigger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;Invalid or no trigger specified in </span><span class="si">{spec}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">regex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modulo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span> <span class="k">if</span> <span class="n">steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;{self.regex if self.regex is not None else &quot;&quot;}@</span><span class="si">{self.modulo}{self.trigger}</span><span class="s1">&#39;</span>


<span class="k">def</span> <span class="nf">read_modulo_string</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>
    <span class="n">regex</span><span class="p">,</span> <span class="n">string</span> <span class="o">=</span> <span class="n">parts</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[0-9]+&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
    <span class="n">trigger</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">BRIEF</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">trigger</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
        <span class="n">trigger</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span><span class="p">[</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">steps</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">regex</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">trigger</span>


<span class="k">class</span> <span class="nc">LastStep</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>


<div class="viewcode-block" id="Hook"><a class="viewcode-back" href="../../api.html#xmen.monitor.Hook">[docs]</a><span class="k">class</span> <span class="nc">Hook</span><span class="p">(</span><span class="n">Spec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A base class defining a variable passing protocol with the Monitor class. Ever time the monitors count is</span>
<span class="sd">    divisible by ``modulo`` for a particular ``trigger`` then the hook is passed all the variables matching ``regex``</span>
<span class="sd">    from the current stack. Users therefore define hooks by overloading the hooks __call__ method (with the same</span>
<span class="sd">    call signature).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_dict</span><span class="p">,</span> <span class="n">monitor</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;All methods must implement the call method&#39;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">EarlyStop</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An early stop implementation. Returns true if the score in most distant memory is &lt;= / &gt;= all other scores</span>
<span class="sd">        in memory. Example:</span>

<span class="sd">        ::</span>
<span class="sd">            import numpy as np</span>
<span class="sd">            import matplotlib.pyplot as plt</span>
<span class="sd">            plt.style.use(&#39;ggplot&#39;)</span>

<span class="sd">            es = EarlyStop(&#39;max&#39;, 36)</span>

<span class="sd">            X = np.linspace(0, 10, 100)</span>
<span class="sd">            Y = 1 - np.sin(X) * X</span>
<span class="sd">            y = []</span>
<span class="sd">            for x in X:</span>
<span class="sd">                y.append(1 - np.sin(x) * x)</span>
<span class="sd">                es.append(y[-1], an_example=True, step=1)</span>
<span class="sd">                if es:</span>
<span class="sd">                    print(f&#39;Breaking at {x}&#39;)</span>
<span class="sd">                    break</span>
<span class="sd">            print(max(es))</span>
<span class="sd">            best, count, tags = max(es)</span>
<span class="sd">            plt.plot(X, Y)</span>
<span class="sd">            plt.plot(X[:len(y)], np.array(y))</span>
<span class="sd">            plt.scatter(X[count], best, color=&#39;red&#39;)</span>
<span class="sd">            plt.show()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">condition</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">memory</span> <span class="o">&gt;=</span> <span class="mi">1</span>

        <span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">memory</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">memory</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">memory</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">tags</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">operator</span>
        <span class="n">op</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">]</span>
        <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">first</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">best</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">)))[</span><span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;EarlyStop({bool(self)}, memory={len(self.history)}, condition=</span><span class="si">{self.condition}</span><span class="s1">, &#39;</span> \
               <span class="n">f</span><span class="s1">&#39;best=</span><span class="si">{best}</span><span class="s1">, count=</span><span class="si">{count}</span><span class="s1">, tags=</span><span class="si">{tags}</span><span class="s1">)&#39;</span>


<span class="k">class</span> <span class="nc">EarlyStopper</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">modulo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">metric</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EarlyStopper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">modulo</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="n">EarlyStop</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">read_modulo_string</span><span class="p">(</span><span class="n">metric</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">monitor</span><span class="p">):</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">pop</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;No Metric was found matching </span><span class="si">{self.metric}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="o">**</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">early_stop</span><span class="p">:</span>
            <span class="n">monitor</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;----- </span><span class="si">{self.early_stop}</span><span class="s1"> ----&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Checkpointer"><a class="viewcode-back" href="../../api.html#xmen.monitor.Checkpointer">[docs]</a><span class="k">class</span> <span class="nc">Checkpointer</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
<div class="viewcode-block" id="Checkpointer.__init__"><a class="viewcode-back" href="../../api.html#xmen.monitor.Checkpointer.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">to_keep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Checkpointer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_keep</span> <span class="o">=</span> <span class="n">to_keep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_buffer</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand</span> <span class="o">=</span> <span class="n">expand</span></div>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_dict</span><span class="p">,</span> <span class="n">monitor</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">torch</span>
        <span class="kn">from</span> <span class="nn">xmen.utils</span> <span class="k">import</span> <span class="n">get_version</span>
        <span class="n">saved</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">monitor</span><span class="o">.</span><span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">monitor</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;WARNING: Cannot checkpoint {list(var_dict.keys())} as monitor does not have a directory&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">:</span>
                <span class="n">pops</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">updates</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">pops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">updates</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">kk</span><span class="p">:</span> <span class="n">vv</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pops</span><span class="p">:</span>
                    <span class="n">var_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">var_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updates</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;state_dict&#39;</span><span class="p">):</span>
                    <span class="c1"># Save directory</span>
                    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;checkpoints&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

                    <span class="c1"># Create directory if it doesn&#39;t exist</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_dir</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>

                    <span class="c1"># Get PATHS in file if buffer is not loaded</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_buffer</span><span class="p">:</span>
                        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
                        <span class="c1"># Order files in ascending order by step (note sort must be used on int)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">([(</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ff</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ff</span><span class="p">)</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_keep</span><span class="p">:</span>
                        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{monitor.step}</span><span class="s1">.pt&#39;</span><span class="p">))</span>
                    <span class="n">save_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">monitor</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">}</span>
                    <span class="n">save_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">get_version</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)),</span>
                        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%I:%M%p %B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span><span class="p">),</span>
                        <span class="s1">&#39;state_dict&#39;</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()})</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_buffer</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">saved</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Value for key = </span><span class="si">{k}</span><span class="s1"> does not have a state_dict&#39;</span><span class="p">)</span>
            <span class="n">monitor</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;saved </span><span class="si">{saved}</span><span class="s1"> at </span><span class="si">{monitor.directory}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="XmenMessenger"><a class="viewcode-back" href="../../api.html#xmen.monitor.XmenMessenger">[docs]</a><span class="k">class</span> <span class="nc">XmenMessenger</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A hook for logging messages with an ``xmen.Experiment`` object.</span>

<span class="sd">        Example 1::</span>

<span class="sd">            from xmen import Experiment</span>
<span class="sd">            from xmen.monitor import Monitor</span>

<span class="sd">            messenger = XmenMessenger(&#39;y.*-&gt;ex.*@10s&#39;)   # log all variables matching the loss to experiments matching ex</span>
<span class="sd">            m = Monitor(hooks=[messenger])</span>
<span class="sd">            y1, y2 = 0, 0</span>
<span class="sd">            ex1, ex2 = Experiment(), Experiment()</span>
<span class="sd">            ex1.register(&#39;/tmp&#39;, &#39;ex1&#39;)</span>
<span class="sd">            ex2.register(&#39;/tmp&#39;, &#39;ex2&#39;)</span>
<span class="sd">            for i in m(range(40)):</span>
<span class="sd">                y1 += 1</span>
<span class="sd">                y2 += 2</span>
<span class="sd">                if i % 10 == 1:</span>
<span class="sd">                    print(&#39;, &#39;.join(</span>
<span class="sd">                        [f&quot;ex1: {k} = {ex1.messages.get(k, None)}&quot; for k in (&#39;y1&#39;, &#39;y2&#39;)] +</span>
<span class="sd">                        [f&quot;ex2: {k} = {ex1.messages.get(k, None)}&quot; for k in (&#39;y1&#39;, &#39;y2&#39;)]))</span>

<span class="sd">            # Output</span>
<span class="sd">            # ex1: y1 = None, ex1: y2 = None, ex2: y1 = None, ex2: y2 = None</span>
<span class="sd">            # ex1: y1 = 10, ex1: y2 = 20, ex2: y1 = 10, ex2: y2 = 20</span>
<span class="sd">            # ex1: y1 = 20, ex1: y2 = 40, ex2: y1 = 20, ex2: y2 = 40</span>
<span class="sd">            # ex1: y1 = 30, ex1: y2 = 60, ex2: y1 = 30, ex2: y2 = 60</span>


<span class="sd">        Example 2::</span>

<span class="sd">            from xmen import Experiment</span>
<span class="sd">            from xmen.monitor import Monitor</span>

<span class="sd">            ex = Experiment()</span>
<span class="sd">            ex.register(&#39;/tmp&#39;, &#39;ex&#39;)</span>
<span class="sd">            m = Monitor(</span>
<span class="sd">                hooks=[</span>
<span class="sd">                    XmenMessenger(&#39;^y$|^i$-&gt;^ex$@10s&#39;, keep=&#39;min&#39;, leader=&#39;^y$&#39;)])</span>

<span class="sd">            x = -50</span>
<span class="sd">            for i in m(range(100)):</span>
<span class="sd">                x += 1</span>
<span class="sd">                y = x ** 2</span>
<span class="sd">                if i % 10 == 1:</span>
<span class="sd">                    print([ex.messages.get(k, None) for k in (&#39;i&#39;, &#39;y&#39;)])</span>

<span class="sd">            # Output</span>
<span class="sd">            # [None, None]</span>
<span class="sd">            # [9, 1600]</span>
<span class="sd">            # [19, 900]</span>
<span class="sd">            # [29, 400]</span>
<span class="sd">            # [39, 100]</span>
<span class="sd">            # [49, 0]</span>
<span class="sd">            # [49, 0]</span>
<span class="sd">            # [49, 0]</span>
<span class="sd">            # [49, 0]</span>
<span class="sd">            # [49, 0]</span>

<span class="sd">        Example 3::</span>

<span class="sd">            from xmen import Experiment</span>
<span class="sd">            from xmen.monitor import Monitor</span>

<span class="sd">            ex = Experiment()</span>
<span class="sd">            ex.register(&#39;/tmp&#39;, &#39;ex&#39;)</span>
<span class="sd">            m = Monitor(</span>
<span class="sd">                hooks=[</span>
<span class="sd">                    XmenMessenger(&#39;z-&gt;^ex$@10s&#39;, keep=&#39;min&#39;, leader=&#39;y&#39;, expand=True)])</span>

<span class="sd">            z = {&#39;x&#39;: 5, &#39;y&#39;: 10}</span>
<span class="sd">            for i in m(range(100)):</span>
<span class="sd">                z[&#39;i&#39;] = i</span>
<span class="sd">                z[&#39;x&#39;] += 1</span>
<span class="sd">                z[&#39;y&#39;] = z[&#39;x&#39;] ** 2</span>
<span class="sd">                if i % 10 == 1:</span>
<span class="sd">                    print([ex.messages.get(k, None) for k in (&#39;i&#39;, &#39;y&#39;, &#39;x&#39;)])</span>

<span class="sd">            # [None, None, None]</span>
<span class="sd">            # [9, 225, 15]</span>
<span class="sd">            # [9, 225, 15]</span>
<span class="sd">            # [9, 225, 15]</span>
<span class="sd">            # [9, 225, 15]</span>
<span class="sd">            # [9, 225, 15]</span>
<span class="sd">            # [9, 225, 15]</span>
<span class="sd">            # [9, 225, 15]</span>
<span class="sd">            # [9, 225, 15]</span>
<span class="sd">            # [9, 225, 15]</span>

<span class="sd">        Example 4::</span>

<span class="sd">            from xmen import Experiment</span>
<span class="sd">            from xmen.monitor import Monitor</span>

<span class="sd">            ex = Experiment()</span>
<span class="sd">            ex.register(&#39;/tmp&#39;, &#39;ex&#39;)</span>
<span class="sd">            m = Monitor(</span>
<span class="sd">                hooks=[</span>
<span class="sd">                    XmenMessenger(&#39;z-&gt;^ex$@10s&#39;, keep=&#39;min&#39;, leader=&#39;z_y&#39;, expand=True, prepend=True)])</span>


<span class="sd">            z = {&#39;x&#39;: 5, &#39;y&#39;: 10}</span>
<span class="sd">            for i in m(range(100)):</span>
<span class="sd">                z[&#39;i&#39;] = i</span>
<span class="sd">                z[&#39;x&#39;] += 1</span>
<span class="sd">                z[&#39;y&#39;] = z[&#39;x&#39;] ** 2</span>
<span class="sd">                if i % 10 == 1:</span>
<span class="sd">                    print([ex.messages.get(k, None) for k in (&#39;z_i&#39;, &#39;z_y&#39;, &#39;z_x&#39;)])</span>

<span class="sd">            # same output as above</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="XmenMessenger.__init__"><a class="viewcode-back" href="../../api.html#xmen.monitor.XmenMessenger.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span> <span class="n">leader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            spec (Spec): hook specification in the form either ``{log_regex}-&gt;{exp_regex}@{modulo}{trigger}`` or</span>
<span class="sd">                ``{exp_regex}@{modulo}{trigger}`` where ``exp_regex`` is the experiments to message and ``log_regex`` are</span>
<span class="sd">                additional messages to log with the experiment. In the second case only timing and step information</span>
<span class="sd">                will be logged</span>
<span class="sd">            keep (str): One of [&#39;latest&#39;, &#39;max&#39;, &#39;min&#39;] in the case of message collision with each experiment</span>
<span class="sd">            leader (regex): If leader is not None then messages will be logged according to ``keep`` as judged by</span>
<span class="sd">                the variable in var_dict which matches ``leader``.</span>
<span class="sd">            expand: If a dictionary variable with K keys matches ``log_regex`` then it is converted to K variables with</span>
<span class="sd">                names corresponding to the keys in dict if ``expand==True``.</span>
<span class="sd">            prepend: If prepend is ``True`` then in the case above the name of each variable will be</span>
<span class="sd">                prepended by the dict variable name. eg. each variable will be called &#39;{name}_{k}&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">keep</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;latest&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep</span> <span class="o">=</span> <span class="n">keep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand</span> <span class="o">=</span> <span class="n">expand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="n">leader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span> <span class="o">=</span> <span class="n">prepend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;-&gt;&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">)</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">spec</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">XmenMessenger</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_dict</span><span class="p">,</span> <span class="n">monitor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Leave messages, timing and step information with experiments&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">xmen.experiment</span> <span class="k">import</span> <span class="n">Experiment</span>

        <span class="c1"># if monitor.directory is None:</span>
        <span class="c1">#     monitor.log(f&#39;WARNING: Cannot log {list(var_dict.keys())} as monitor does not have a directory&#39;)</span>
        <span class="c1"># else:</span>
        <span class="c1"># get and remove experiments from var_dict</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">var_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">var_dict</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">names</span><span class="p">,</span> <span class="n">experiments</span> <span class="o">=</span> <span class="n">results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">var_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">:</span>
            <span class="c1"># Expand dictionaries in var_dict</span>
            <span class="n">pop</span><span class="p">,</span> <span class="n">add</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>
                    <span class="n">add</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">p</span> <span class="o">+</span> <span class="n">kk</span><span class="p">:</span> <span class="n">vv</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
                    <span class="n">pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pop</span><span class="p">:</span>
                <span class="n">var_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">var_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
            <span class="c1"># Get leader</span>
            <span class="n">leader</span><span class="p">,</span> <span class="n">best_leader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">leader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">leader</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">var_dict</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leader</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Experiment</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">var_dict</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="p">,</span> <span class="n">leader</span><span class="o">=</span><span class="n">leader</span><span class="p">)</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">var_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">monitor</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Left messages {keys if keys != [] else &quot;&quot;} with </span><span class="si">{name}</span><span class="s1"> at </span><span class="si">{e.directory}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Timer"><a class="viewcode-back" href="../../api.html#xmen.monitor.Timer">[docs]</a><span class="k">class</span> <span class="nc">Timer</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple timing hook used to log any timers open_socket by the experiment monitor&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_dict</span><span class="p">,</span> <span class="n">monitor</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BRIEF</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;last&#39;</span><span class="p">]</span>
        <span class="n">monitor</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{k}</span><span class="s1">=</span><span class="si">{s[k]}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">Probe</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple probing hook used to retrieve and log a system snapshot with the experiment&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_dict</span><span class="p">,</span> <span class="n">monitor</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">update_meta</span><span class="p">(</span><span class="n">get_cpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">get_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">cpu</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cpu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cpu_use</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cpu</span><span class="p">[</span><span class="s1">&#39;usage&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpu</span><span class="p">[</span><span class="s1">&#39;usage&#39;</span><span class="p">])</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot;cpu=</span><span class="si">{cpu_use}</span><span class="s2">%&quot;</span>
                <span class="n">gpu</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gpu&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gpu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;   &#39;</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;   &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{kk}</span><span class="s2"> = </span><span class="si">{vv[&#39;name&#39;]}</span><span class="s2"> </span><span class="si">{vv[&#39;load&#39;]}</span><span class="s2"> </span><span class="si">{vv[&#39;memory&#39;]}</span><span class="s2"> </span><span class="si">{vv[&#39;temperature&#39;]}</span><span class="s2">&quot;</span>
                                       <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">gpu</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                    <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;   &#39;</span>
                <span class="n">monitor</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>


<div class="viewcode-block" id="Logger"><a class="viewcode-back" href="../../api.html#xmen.monitor.Logger">[docs]</a><span class="k">class</span> <span class="nc">Logger</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple logging hook used to log variables to stdout.</span>

<span class="sd">    Example::</span>

<span class="sd">        from xmen.monitor import Monitor, Logger</span>

<span class="sd">        m = Monitor(</span>
<span class="sd">            hooks=[</span>
<span class="sd">                Logger(&#39;x@2s&#39;, process_func=lambda x: &#39;|&#39;.join(x)),</span>
<span class="sd">                Logger(&#39;y@1e&#39;, format=&#39;.5f&#39;)])</span>

<span class="sd">        x = [&#39;cat&#39;, &#39;dog&#39;]</span>
<span class="sd">        y = 0.</span>
<span class="sd">        for _ in m(range(3)):</span>
<span class="sd">            for i in m(range(5)):</span>
<span class="sd">                y += i</span>

<span class="sd">        # [01:17PM 18/11/20 0/3 2/15]: x = cat|do</span>
<span class="sd">        # [01:17PM 18/11/20 0/3 4/15]: x = cat|do</span>
<span class="sd">        # [01:17PM 18/11/20 1/3]: y = 10.0000</span>
<span class="sd">        # [01:17PM 18/11/20 1/3 6/15]: x = cat|do</span>
<span class="sd">        # [01:17PM 18/11/20 1/3 8/15]: x = cat|do</span>
<span class="sd">        # [01:17PM 18/11/20 1/3 10/15]: x = cat|do</span>
<span class="sd">        # [01:17PM 18/11/20 2/3]: y = 20.0000</span>
<span class="sd">        # [01:17PM 18/11/20 2/3 12/15]: x = cat|do</span>
<span class="sd">        # [01:17PM 18/11/20 2/3 14/15]: x = cat|do</span>
<span class="sd">        # [01:17PM 18/11/20 3/3]: y = 30.0000</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Logger.__init__"><a class="viewcode-back" href="../../api.html#xmen.monitor.Logger.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">process_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            spec (Spec): a specification string of the form &quot;{regex}@{modulo}{trigger}&quot;. Variables matching</span>
<span class="sd">                ``regex`` will be logged when ``trigger`` % ``modulo`` == 0.</span>
<span class="sd">            format (str): a format string used as f&quot;{var:format}&quot; for logging string variables</span>
<span class="sd">            process_func (callable): used to convert variables to a string for logging to stdout. Format will be</span>
<span class="sd">                applied after.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Logger</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="nb">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_func</span> <span class="o">=</span> <span class="n">process_func</span></div>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_dict</span><span class="p">,</span> <span class="n">monitor</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">process_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log variables to standard out&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">triggers</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">BRIEF</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{s[&quot;last&quot;]}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">elems</span> <span class="o">+=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{s[k]}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">triggers</span><span class="p">]</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]:&#39;</span>
        <span class="c1"># string = &#39; &#39;.join(elems) + &#39;:&#39;</span>
        <span class="c1"># Log other arguments</span>
        <span class="n">process_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_func</span> <span class="k">if</span> <span class="n">process_func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">process_func</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">format</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">process_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">process_func</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39; </span><span class="si">{k}</span><span class="s1"> = {v:</span><span class="si">{format}</span><span class="s1">}&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_dict</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">process_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">process_func</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39; {v:</span><span class="si">{format}</span><span class="s1">}&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>


<div class="viewcode-block" id="TensorboardLogger"><a class="viewcode-back" href="../../api.html#xmen.monitor.TensorboardLogger">[docs]</a><span class="k">class</span> <span class="nc">TensorboardLogger</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A hook for logging tensorboard summaries. Currently ``image``, ``scalar``, ``histogram``, ``figure``,</span>
<span class="sd">    ``video``, ``text``, ``pr_curve``, ``mesh`` are all supported.</span>

<span class="sd">    Before being passed to the summary writer each variable is processes as follows:</span>

<span class="sd">        1. First all variables are passed to ``fn`` (if supplied).</span>
<span class="sd">        2. Variables of type list or dict with length K will be expanded to give K variables. The name of each variable</span>
<span class="sd">           will be the list name postpended with its index or the dictionary name postpended with its key.</span>
<span class="sd">        3. If the summary type is image or scalar then some additional processing will be performed:</span>

<span class="sd">            1. For scalars if variables are not already scalar variables they will be converted by calling var.mean()</span>
<span class="sd">            2. For images the variable must be either a 3D [C, H, W] or 4D [B, C, H, W] tensor. Tensors are converted</span>
<span class="sd">               to images of shape [C, H, W]:</span>
<span class="sd">            3. if the variable is 3D it will be converted to 4D</span>
<span class="sd">            4. the variable is then converted to an image using ``torchvision.utils.make_grid``. Additional options</span>
<span class="sd">               can be passed to ``torchvision.utils.make_grid`` using the ``options`` parameter. Available options</span>
<span class="sd">               include:</span>

<span class="sd">                - ``&#39;nrow&#39; # images per row``</span>
<span class="sd">                - ``&#39;padding&#39;``</span>
<span class="sd">                - ``&#39;normalize&#39;``</span>
<span class="sd">                - ``&#39;range&#39;``</span>
<span class="sd">                - ``&#39;scale_each&#39;``</span>
<span class="sd">                - ``&#39;pad_value&#39;``</span>
<span class="sd">                (see torchvision.utils.make_grid for more info)</span>


<span class="sd">    Note:</span>
<span class="sd">        Tensorboard does not allow summaries to have the same name. If you want to leave to different types</span>
<span class="sd">        of summary for the same variable then you will need to use the `prefix` argument.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="TensorboardLogger.__init__"><a class="viewcode-back" href="../../api.html#xmen.monitor.TensorboardLogger.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            type (str): The type of tensorboard summary to log. Should be one of</span>
<span class="sd">                [&#39;image&#39;, &#39;scalar&#39;, &#39;histogram&#39;, &#39;figure&#39;, &#39;video&#39;, &#39;text&#39;, &#39;pr_curve&#39;, &#39;mesh&#39;]</span>
<span class="sd">            spec (str): A string in the form ``&quot;{regex}@{modulo}{trigger}&quot;``. tensorbaord summaries will be logged</span>
<span class="sd">                for all variables matching ``regex`` when ``monitor.{trigger} % modulo == 0`</span>
<span class="sd">            fn (callable): A function used to convert each variable to a summary</span>
<span class="sd">            prefix (str): prepend all summaries with this string</span>
<span class="sd">            prepend (bool): If true prepend dictionary variable names with the dictionary name.</span>
<span class="sd">            **options: Keyword arguments passed to ``torchvision.utils.make_grid``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TensorboardLogger</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span> <span class="o">=</span> <span class="n">prepend</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="s1">&#39;histogram&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;pr_curve&#39;</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only image and scalar summaries are currently supported.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span></div>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_dict</span><span class="p">,</span> <span class="n">monitor</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">torch.utils.tensorboard</span> <span class="k">as</span> <span class="nn">tb</span>

            <span class="k">if</span> <span class="n">monitor</span><span class="o">.</span><span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">monitor</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;WARNING: Cannot log {list(var_dict.keys())} to tensorboard as &#39;</span>
                            <span class="n">f</span><span class="s1">&#39;monitor does not have a directory&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;summaries&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;summaries&#39;</span><span class="p">))</span>
                <span class="kn">from</span> <span class="nn">torch.utils.tensorboard</span> <span class="k">import</span> <span class="n">SummaryWriter</span>
                <span class="n">tb_writer</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">SummaryWriter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;summaries&#39;</span><span class="p">))</span>
                <span class="n">monitor</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;saved tb </span><span class="si">{self.type}</span><span class="s1"> summaries for {list(var_dict.keys())} at </span><span class="si">{monitor.directory}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># print(monitor.directory, &#39;summaries&#39;)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">k</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">add_summary</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tb_writer</span><span class="p">,</span> <span class="s1">&#39;add_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_compatible</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
                                <span class="n">p</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepend</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                                <span class="n">add_summary</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">monitor</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                                <span class="n">vv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_compatible</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
                                <span class="n">add_summary</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">vv</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">monitor</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_compatible</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                            <span class="n">add_summary</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">monitor</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
                <span class="n">tb_writer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">tb_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="TensorboardLogger.make_compatible"><a class="viewcode-back" href="../../api.html#xmen.monitor.TensorboardLogger.make_compatible">[docs]</a>    <span class="k">def</span> <span class="nf">make_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the variable v to a valid input for the summary writer&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">torch</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">from</span> <span class="nn">torchvision.utils</span> <span class="k">import</span> <span class="n">make_grid</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;detach&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;clone&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nrow&#39;</span><span class="p">,</span> <span class="s1">&#39;padding&#39;</span><span class="p">,</span> <span class="s1">&#39;normalize&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="s1">&#39;scale_each&#39;</span><span class="p">,</span> <span class="s1">&#39;pad_value&#39;</span><span class="p">}</span>
            <span class="n">make_grid_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;normalize&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;scale_each&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="n">make_grid_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">options</span><span class="p">})</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">make_grid</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="o">**</span><span class="n">make_grid_params</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># Make images a grid if batched and normalise each</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">make_grid</span><span class="p">([</span><span class="n">v</span><span class="p">],</span> <span class="o">**</span><span class="n">make_grid_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;scalar&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">v</span></div></div>


<span class="k">class</span> <span class="nc">StopWatch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple timer class&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_format</span><span class="o">=</span><span class="s1">&#39;.4f&#39;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%j %H:%M:%S&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            name (str): the name of the stopwatch</span>
<span class="sd">            length (int): the number of steps to time for (can be None)</span>
<span class="sd">            time_format (str): display timings in this format</span>
<span class="sd">            date_format (str): display date in this format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">since_start</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t_fmt</span> <span class="o">=</span> <span class="n">time_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_date_fmt</span> <span class="o">=</span> <span class="n">date_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start the stop watch&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the stopwatch&quot;&quot;&quot;</span>
        <span class="n">now_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">now_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">average</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mf">1.</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">projected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_more</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get projected time to completion. If ``n_more is None`` then the time to completion will be inferred</span>
<span class="sd">        from ``length``. As a result at least of one of ``n_more`` or ``length`` must be set&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">n_more</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;One of n_more or length must be set&#39;</span>
        <span class="k">if</span> <span class="n">n_more</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_more</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">average</span> <span class="o">*</span> <span class="n">n_more</span>

    <span class="k">def</span> <span class="nf">wall_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The time since the experiment started in seconds&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation&quot;&quot;&quot;</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.name}</span><span class="s1"> {self.delta:</span><span class="si">{self._t_fmt}</span><span class="s1">}secs ({self.average:</span><span class="si">{self._t_fmt}</span><span class="s1">} avg)&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39; wall &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_date_fmt</span><span class="p">,</span>  <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">))</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39; finish &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_date_fmt</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projected</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">string</span>


<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../api.html#xmen.monitor.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">load_dir</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attempt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">modules</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load torch objects from a checkpoint object. If ``Step is None`` then the most recent checkpoint is loaded.</span>
<span class="sd">    Else the checkpoint is loaded at the specified step. If attempt == False then load will raise a ValueError</span>
<span class="sd">    if either one of the modules was not found in modules or if no checkpoints were found in load_dir.</span>

<span class="sd">    Note:</span>
<span class="sd">        No check to ensure the meta information in each file is the same. The meta information returned corresponds</span>
<span class="sd">        to the first module encountered in modules.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">torch</span>
    <span class="k">if</span> <span class="n">load_dir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">load_dir</span> <span class="o">=</span> <span class="n">load_dir</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">load_dir</span> <span class="o">+</span> <span class="s1">&#39;/*&#39;</span><span class="p">)</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">load_step</span> <span class="o">=</span> <span class="n">step</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">folders</span><span class="p">):</span>
            <span class="n">module_key</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">module_key</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
                <span class="c1"># Order files in ascending order by step (note sort must be used on int)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">([(</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ff</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ff</span><span class="p">)</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;No checkpoint found for </span><span class="si">{f}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">attempt</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">file</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>     <span class="c1"># Take most recent</span>
                    <span class="n">load_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                        <span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Could not find checkpoint at step </span><span class="si">{step}</span><span class="s1"> for </span><span class="si">{f}</span><span class="s1">&#39;</span>
                        <span class="k">if</span> <span class="n">attempt</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">TRIGGERS</span><span class="p">})</span>
                <span class="k">if</span> <span class="s1">&#39;state_dict&#39;</span> <span class="ow">in</span> <span class="n">checkpoint</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">modules</span><span class="p">[</span><span class="n">module_key</span><span class="p">],</span> <span class="s1">&#39;load_state_dict&#39;</span><span class="p">):</span>
                        <span class="n">modules</span><span class="p">[</span><span class="n">module_key</span><span class="p">]</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">])</span>
                        <span class="n">found</span> <span class="o">+=</span> <span class="p">[</span><span class="n">module_key</span><span class="p">]</span>
                        <span class="n">steps</span> <span class="o">+=</span> <span class="p">[</span><span class="n">load_step</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Loaded </span><span class="si">{found}</span><span class="s2"> at step </span><span class="si">{steps}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Keys </span><span class="si">{missing}</span><span class="s1"> were not found in the checkpoint&#39;</span>
            <span class="k">if</span> <span class="n">attempt</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;No checkpoints exist in </span><span class="si">{load_dir}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">attempt</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeWarning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">modules</span><span class="p">,</span> <span class="n">meta</span></div>


<div class="viewcode-block" id="Monitor"><a class="viewcode-back" href="../../api.html#xmen.monitor.Monitor">[docs]</a><span class="k">class</span> <span class="nc">Monitor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Automate tracking and logging of experiments.</span>

<span class="sd">    Configured through arguments of the form ``f&#39;{regex}@{modulo}{trigger}&#39;``.</span>
<span class="sd">    Any variables in the local scope of the monitor which match the</span>
<span class="sd">    specified regular expression will be logged every modulo steps of the trigger. Triggers are</span>
<span class="sd">    incremented either manually (using the ``inc`` method) or automatically using nested iterators</span>
<span class="sd">    (see example). Supported triggers include [&quot;step&quot;, &quot;epoch&quot;, &quot;era&quot;, &quot;eon&quot;, &quot;supereon&quot;] or their</span>
<span class="sd">    abbreviations [&quot;s&quot;, &quot;e&quot;, &quot;er&quot;, &quot;eo&quot;, &quot;se&quot;].</span>

<span class="sd">    If a hook is passed with modulo == None it can instead be triggered manually</span>
<span class="sd">    as ``monitor.to_hooks()``.</span>

<span class="sd">    Example::</span>

<span class="sd">        from xmen import Experiment</span>
<span class="sd">        from xmen.monitor import Monitor</span>

<span class="sd">        X = Experiment(..., ...)</span>

<span class="sd">        a, b, c, d, e, f = 0, 0, 0, 0, 0, 0</span>


<span class="sd">        def identity(x):</span>
<span class="sd">            return x</span>


<span class="sd">        def mult(x):</span>
<span class="sd">            return 10 * x</span>


<span class="sd">        m = Monitor(</span>
<span class="sd">            log=(&#39;a|b@2s&#39;, &#39;b@1e&#39;, &#39;c@1er&#39;, &quot;d|e@1eo&quot;, &quot;e@1se&quot;),</span>
<span class="sd">            log_fn=(mult, identity, identity, identity, identity),</span>
<span class="sd">            log_format=&#39;.3f&#39;,</span>
<span class="sd">            msg=&#39;a-&gt;X@1s&#39;,</span>
<span class="sd">            time=(&#39;@2s&#39;, &#39;@1e&#39;),</span>
<span class="sd">            probe=&#39;X@10s&#39;,</span>
<span class="sd">            limit=&#39;@20s&#39;)</span>
<span class="sd">        for _ in m(range(2)):</span>
<span class="sd">            for _ in m(range(2)):</span>
<span class="sd">                for _ in m(range(3)):</span>
<span class="sd">                    for _ in m(range(4)):</span>
<span class="sd">                        for _ in m(range(5)):</span>
<span class="sd">                            a += 1</span>
<span class="sd">                        b += 1</span>
<span class="sd">                    c += 1</span>
<span class="sd">                d += 1</span>
<span class="sd">            e += 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Monitor.__init__"><a class="viewcode-back" href="../../api.html#xmen.monitor.Monitor.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">hooks</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">time</span><span class="o">=</span><span class="p">(),</span>
                 <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg_keep</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span> <span class="n">msg_leader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg_expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">msg_prep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">probe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            hooks (Iterable[Hook]): User defined hooks used to extend the functionality of the Monitor class inheriting</span>
<span class="sd">                from ``Hook``.</span>
<span class="sd">            log (str, Iterable[str]): A modulo string of the form ``&quot;f{regex}&quot;`` or ``&quot;{regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to log @ a particular logging frequency to stdout.</span>
<span class="sd">            log_fn (Callable,  Iterable[Callable]): Converts the variable into a string for logging.</span>
<span class="sd">            log_format (str,  Iterable[str]): A format used to format a string as ``f&quot;{string}:{format}&quot;``</span>
<span class="sd">            time (str,  Iterable[str]): A string of the form ``f&quot;@{steps}&quot;`` to log timing statistics at (or list of for different</span>
<span class="sd">                triggers).</span>
<span class="sd">            msg (str,  Iterable[str]): A modulo string of the form ``&quot;{regex}-&gt;{exp_regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to log as messages with the experiments matching ``exp_regex``.</span>
<span class="sd">            msg_keep (str, Iterable[str]): One of [&#39;latest&#39;, &#39;max&#39;, &#39;min&#39;] giving the protocol to use on message collision</span>
<span class="sd">            msg_leader (str, Iterable[str]): A regex to a single variable. If supplied then this variable will be treated as the leader</span>
<span class="sd">                and all other variables will be logged only if the keep condition is met for the leader</span>
<span class="sd">            msg_expand (bool, Iterable[str]): If True then dictionary variables with K keys will be expanded to give K variables</span>
<span class="sd">            msg_prep (bool, Iterable[str]): If True then each variable in the dictionary will be prepended by the dictionary name.</span>
<span class="sd">            probe (str, Iterable[str]): A string of the form ``f&quot;{regex}@{steps}&quot;`` to log resource use to each</span>
<span class="sd">                experiment that matches regex (or list of for different triggers).</span>
<span class="sd">            limit (str,  Iterable[str]): A modulo string of the form ``f&quot;@{modulo}{triger}&quot; used to limit the number of iterations of</span>
<span class="sd">                an experiment at a particular trigger level. This is useful if an experiment is restarted for</span>
<span class="sd">                example.</span>

<span class="sd">        Note:</span>
<span class="sd">            All variables ``ckpt_keep``, ``msg_leader``,</span>
<span class="sd">            ``msg_expand`` and ``msg_prep`` can be supplied as a single or as a list of entries, one for each set of</span>
<span class="sd">            variables matching each modulo string in each case.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">TRIGGERS</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_regex</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_reached</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">read_modulo_string</span><span class="p">(</span><span class="n">limit</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">log</span> <span class="o">=</span> <span class="p">[</span><span class="n">log</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log_fn</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">log_fn</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">log_fn</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log_format</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">log_format</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">log_format</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">))</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;Either one fn, pref and prep or one for each &#39;</span><span class="si">{log}</span><span class="s2">&#39; must be set&quot;</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">log_fn</span><span class="p">,</span> <span class="n">log_format</span><span class="p">)),</span> <span class="n">warn</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">log_fn</span><span class="p">,</span> <span class="n">log_format</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Logger</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Timer</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg_keep</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">msg_keep</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">msg_keep</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg_leader</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">msg_leader</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">msg_leader</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg_prep</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">msg_prep</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">msg_prep</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg_expand</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">msg_expand</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">msg_expand</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;Either one fn, pref and prep or one for each &#39;</span><span class="si">{msg}</span><span class="s2">&#39; must be set&quot;</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msg_keep</span><span class="p">,</span> <span class="n">msg_leader</span><span class="p">,</span> <span class="n">msg_expand</span><span class="p">,</span> <span class="n">msg_prep</span><span class="p">)),</span> <span class="n">warn</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">pr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg_keep</span><span class="p">,</span> <span class="n">msg_leader</span><span class="p">,</span> <span class="n">msg_expand</span><span class="p">,</span> <span class="n">msg_prep</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XmenMessenger</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">pr</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">probe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">probe</span> <span class="o">=</span> <span class="p">[</span><span class="n">probe</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">probe</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Probe</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

        <span class="c1"># Add user hooks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_user_hooks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">)</span>

        <span class="c1"># -- Use Logger and Check pointer for manual logging</span>
        <span class="c1"># These special hooks are always available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">supereon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;supereon&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;eon&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">era</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;era&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_reached</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">back</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manage incrementing triggers, logging and collecting timing statistics around current the passed</span>
<span class="sd">        iterator.</span>

<span class="sd">        Args:</span>
<span class="sd">            iter: An iterator</span>
<span class="sd">            back: The number of calls back up to the frame from which called once inside ``inc()``.</span>
<span class="sd">            length: The length of the iterator (useful i length is known but iterator does not have attribute __len__)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_reached</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;---- Stop Criterion @ &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{k}</span><span class="s2">=</span><span class="si">{v}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; ----&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">load</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span>

        <span class="c1"># Promote old timers</span>
        <span class="k">if</span> <span class="n">TRIGGERS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">:</span>  <span class="c1"># Setup (all triggers start at 0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">next_trigger</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">TRIGGERS</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
                        <span class="nb">reversed</span><span class="p">(</span><span class="n">TRIGGERS</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">)]))):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">next_trigger</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">trigger</span><span class="p">])})</span>

        <span class="c1"># Get current trigger level</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">TRIGGERS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">TRIGGERS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">TRIGGERS</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TRIGGERS</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Add timing and logging for current trigger level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">load</span><span class="p">:</span> <span class="n">StopWatch</span><span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span> <span class="n">step</span><span class="p">:</span> <span class="n">StopWatch</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">length</span><span class="p">)}</span>

        <span class="k">def</span> <span class="nf">trigger</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TRIGGERS</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">trigger</span><span class="p">()][</span><span class="n">load</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trigger</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="n">trigger</span><span class="p">()]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;---- Limit reached for </span><span class="si">{self.limit[1]}</span><span class="s1"> </span><span class="si">{self.limit[0]}</span><span class="s1"> ----&#39;</span><span class="p">)</span>
                <span class="c1"># self._limit_reached = True</span>
                <span class="c1"># print(f&#39;Limit reached for {self.limit[1]} {self.limit[0]}&#39;)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_reached</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">trigger</span><span class="p">()][</span><span class="n">load</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">trigger</span><span class="p">()][</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">yield</span> <span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">trigger</span><span class="p">()][</span><span class="n">step</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">trigger</span><span class="p">(),</span> <span class="n">back</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">trigger</span><span class="p">()][</span><span class="n">load</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Remove timers and hooks for trigger</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">trigger</span><span class="p">)</span>

<div class="viewcode-block" id="Monitor.inc"><a class="viewcode-back" href="../../api.html#xmen.monitor.Monitor.inc">[docs]</a>    <span class="k">def</span> <span class="nf">inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">back</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manually increment trigger. Will also run modulo hooks defined by the user.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">trigger</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TRIGGERS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{trigger}</span><span class="s1"> is not in </span><span class="si">{TRIGGERS}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="n">trigger</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">back</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">f_back</span>
        <span class="n">possible_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hook</span><span class="o">.</span><span class="n">modulo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modulo</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="n">hook</span><span class="o">.</span><span class="n">modulo</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hook</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="n">trigger</span><span class="p">:</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">hook</span><span class="o">.</span><span class="n">regex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">possible_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">regex</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
                <span class="n">hook</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Monitor.to_hooks"><a class="viewcode-back" href="../../api.html#xmen.monitor.Monitor.to_hooks">[docs]</a>    <span class="k">def</span> <span class="nf">to_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pass all keyword arguments to manual hooks (hooks where modulo is None)&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hook</span><span class="o">.</span><span class="n">modulo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">regex</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
                <span class="n">hook</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Monitor.log"><a class="viewcode-back" href="../../api.html#xmen.monitor.Monitor.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">process_func</span><span class="o">=</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log string with time, epoch and step.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Value to be logged</span>
<span class="sd">            format: The format used to convert x to a string as &#39;{x:{format}}&#39;</span>
<span class="sd">            process_func: A callable able to convert x to a valid format for printing as {x:{format}}&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">({},</span> <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">process_func</span><span class="o">=</span><span class="n">process_func</span><span class="p">)</span></div>

<div class="viewcode-block" id="Monitor.modulo"><a class="viewcode-back" href="../../api.html#xmen.monitor.Monitor.modulo">[docs]</a>    <span class="k">def</span> <span class="nf">modulo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">modulo</span><span class="p">,</span> <span class="n">exclude_1st</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if trigger % modulo == 0. If exclude_1st is True then modulo will return False for triggers at 0&quot;&quot;&quot;</span>
        <span class="n">is_trigger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="n">trigger</span><span class="p">]</span> <span class="o">%</span> <span class="n">modulo</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">exclude_1st</span><span class="p">:</span>
            <span class="n">is_trigger</span> <span class="o">=</span> <span class="n">is_trigger</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="p">[</span><span class="n">trigger</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">is_trigger</span></div>

<div class="viewcode-block" id="Monitor.summary"><a class="viewcode-back" href="../../api.html#xmen.monitor.Monitor.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Summarise the current state of the experiment monitor&quot;&quot;&quot;</span>
        <span class="c1"># Get statistics</span>
        <span class="n">timings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">summaries</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%I:%M%p </span><span class="si">%d</span><span class="s2">/%m/%y&quot;</span><span class="p">)}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">x</span><span class="p">))</span>

            <span class="n">k</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">wall</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span>
                <span class="n">k</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;step&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;step&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;step&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wall_time</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">TRIGGERS</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">])</span>

            <span class="n">so_far</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">length</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">wall</span> <span class="o">=</span> <span class="n">wall</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">lnow</span><span class="p">,</span> <span class="n">lnext</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">offset</span><span class="p">)):</span>
                    <span class="n">so_far</span> <span class="o">+=</span> <span class="n">n</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="p">[</span><span class="n">total</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">lnow</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">lnext</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">so_far</span> <span class="o">*=</span> <span class="n">lnext</span>
                <span class="k">if</span> <span class="n">so_far</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="c1"># There is a case once an inner iterator terminates for the</span>
                    <span class="c1"># first time meaning that the higher order iterator has yet to be triggered,</span>
                    <span class="c1"># left == 0. and a ZeroDivisionError will occur. It could be assumed that the trigger is just</span>
                    <span class="c1"># about to be triggered and left promoted to 1.0. In the</span>
                    <span class="c1"># case of iterators with a lot of work after the inner iterator has terminated then</span>
                    <span class="c1"># this timing estimate could be inaccurate. Instead when this case occurs (which is a minority)</span>
                    <span class="c1"># I ignore the timing.</span>
                    <span class="n">lnext</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">lnext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">wall</span> <span class="o">/</span> <span class="n">so_far</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">so_far</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">left</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">length</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="n">length</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">total</span><span class="p">)]</span> <span class="o">=</span> <span class="n">total</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="n">timer</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">TRIGGERS</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">]):</span>
                <span class="n">step_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{int(self.triggers[trigger])}&#39;</span>
                <span class="k">if</span> <span class="n">step_timer</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;/{int(length[i])}&#39;</span>
                    <span class="c1"># val += f&#39;%{step_timer.length}&#39;</span>
                <span class="n">summaries</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">BRIEF</span><span class="p">[</span><span class="n">trigger</span><span class="p">]:</span> <span class="n">val</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="c1"># Get trigger with highest precedance</span>
                <span class="n">trigger</span><span class="p">,</span> <span class="n">timer</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">TRIGGERS</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timers</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">step_timer</span><span class="p">,</span> <span class="n">load_timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">],</span> <span class="n">timer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">load_timer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">step_timer</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">step_timer</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">timings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">step_timer</span><span class="o">.</span><span class="n">average</span> <span class="o">+</span> <span class="n">load_timer</span><span class="o">.</span><span class="n">average</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">step_timer</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">step_timer</span><span class="o">.</span><span class="n">n</span><span class="p">))})</span>
                        <span class="n">timings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span><span class="n">step_timer</span><span class="o">.</span><span class="n">delta</span><span class="p">),</span>
                             <span class="s1">&#39;m_step&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span><span class="n">step_timer</span><span class="o">.</span><span class="n">average</span><span class="p">),</span>
                             <span class="s1">&#39;load&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span><span class="n">load_timer</span><span class="o">.</span><span class="n">delta</span><span class="p">),</span>
                             <span class="s1">&#39;m_load&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span><span class="n">load_timer</span><span class="o">.</span><span class="n">average</span><span class="p">)})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">step_timer</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">timings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span>
                                <span class="n">step_timer</span><span class="o">.</span><span class="n">average</span> <span class="o">*</span> <span class="p">(</span><span class="n">step_timer</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">step_timer</span><span class="o">.</span><span class="n">n</span><span class="p">))})</span>
                    <span class="n">timings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span><span class="n">step_timer</span><span class="o">.</span><span class="n">delta</span><span class="p">),</span>
                         <span class="s1">&#39;m_step&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span><span class="n">step_timer</span><span class="o">.</span><span class="n">average</span><span class="p">)})</span>
            <span class="n">summaries</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;wall&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span><span class="n">wall</span><span class="p">)})</span>
            <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">summaries</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">to_date</span><span class="p">(</span><span class="n">left</span><span class="p">)})</span>
            <span class="n">summaries</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">timings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summaries</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;triggers: </span><span class="si">{self.triggers}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="n">f</span><span class="s1">&#39;, current state: </span><span class="si">{summary}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">string</span></div>


<div class="viewcode-block" id="TorchMonitor"><a class="viewcode-back" href="../../api.html#xmen.monitor.TorchMonitor">[docs]</a><span class="k">class</span> <span class="nc">TorchMonitor</span><span class="p">(</span><span class="n">Monitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Automate tracking, logging and saving of experiments with additional</span>
<span class="sd">    hooks for logging to tensorboard and checkpointing of experiments.</span>

<span class="sd">    Manual logging and checkpoint are also supported as</span>
<span class="sd">    ``monitor.log(...)`` and ``monitor.checkpoint(...)``&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TorchMonitor.__init__"><a class="viewcode-back" href="../../api.html#xmen.monitor.TorchMonitor.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="c1"># User defined hooks (either) modulo or not modulo</span>
                 <span class="n">hooks</span><span class="o">=</span><span class="p">[],</span>
                 <span class="c1"># Default saving for parameters</span>
                 <span class="n">ckpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ckpt_keep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">img</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_pref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">img_prep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">img_options</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">sca</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sca_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sca_pref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sca_prep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">hist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hist_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hist_pref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">hist_prep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_pref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fig_prep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">txt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">txt_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">txt_pref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">txt_prep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">vid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vid_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vid_pref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">vid_prep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">time</span><span class="o">=</span><span class="p">(),</span>
                 <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg_keep</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span> <span class="n">msg_leader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg_expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">msg_prep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">probe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            directory (str): The directory used to log checkpoints in</span>
<span class="sd">            hooks (Iterable[Hook]): User defined hooks used to extend the functionality of the Monitor class</span>
<span class="sd">            ckpt (str, Iterable[str]): A modulo string of the form ``&quot;f{regex}&quot;`` or ``&quot;{regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to checkpoint @ a particular logging frequency to stdout. The regex much match</span>
<span class="sd">                objects inheriting form torch.Module.</span>
<span class="sd">            ckpt_keep (int, Iterable[int]): The number of checkpoints to keep. The most recent checkpoints will be kept. If None</span>
<span class="sd">                then all checkpoints will be kept.</span>
<span class="sd">            log (str, Iterable[str]): A modulo string of the form ``&quot;f{regex}&quot;`` or ``&quot;{regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to log @ a particular logging frequency to stdout.</span>
<span class="sd">            log_fn (Callable, Iterable[Callable]): Converts the variable into a string for logging.</span>
<span class="sd">            log_format (str, Iterable[str]): A format used to format a string as ``f&quot;{string}:{format}&quot;``</span>
<span class="sd">            time (str, Iterable[str]): A string of the form ``f&quot;@{steps}&quot;`` to log timing statistics at (or list of for different</span>
<span class="sd">                triggers).</span>
<span class="sd">            img (str, Iterable[str]): A modulo string of the form ``&quot;f{regex}&quot;`` or ``&quot;{regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to add as tensorboard images @ a particular logging frequency.</span>
<span class="sd">            img_fn (Callable, Iterable[Callable]): Converts the variable into an image of shape [B, C, H, W] or [C, H, W] for tensorboard.</span>
<span class="sd">                See TensorBoardLogger for more details in terms of automatic-processing. If ``img`` is a list then</span>
<span class="sd">                ``img_fn`` can also be passed as list with a callable for each entry in ``img`` or can be passed as</span>
<span class="sd">                a single callable used for all entries.</span>
<span class="sd">            img_pref (str, Iterable[str]): Prefix all summaries in tensorboard with this string</span>
<span class="sd">            img_prep (bool, Iterable[bool]): If True then dictionary variables will be prepended by the name of the dictionary</span>
<span class="sd">            img (str, Iterable[str]): A modulo string of the form ``&quot;{regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to add as tensorboard scalars @ a particular logging frequency.</span>
<span class="sd">            sca_fn (Callable, Iterable[Callable]): Converts the variable into a scalar for tensorboard.</span>
<span class="sd">                See TensorBoardLogger for more details in terms of automatic-processing. If ``sca`` is a list then</span>
<span class="sd">                ``sca_fn`` can also be passed as list with a callable for each entry in ``sca`` or can be passed as</span>
<span class="sd">                a single callable used for all entries.</span>
<span class="sd">            sca_pref (str, Iterable[str]): Prefix all summaries in tensorboard with this string</span>
<span class="sd">            sca_prep (bool, Iterable[bool]): If True then dictionary variables will be prepended by the name of the dictionary</span>
<span class="sd">            hist (str, Iterable[str]): A modulo string of the form ``&quot;{regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to add as tensorboard histograms @ a particular logging frequency.</span>
<span class="sd">                If no logging frequency is supplied then any variable logged in the experiment which matches</span>
<span class="sd">                ``regex`` will be logged to tensorboard each time it is passed to the logger.</span>
<span class="sd">                This is useful for logging variables at the end of an epoch for example.</span>
<span class="sd">            hist_fn (Callable, Iterable[Callable]): Preprocess variable before logging to tensorboard.</span>
<span class="sd">                If ``hist`` is a list then ``hist_fn`` can also be passed as list with a callable for each entry in</span>
<span class="sd">                ``hist`` or can be passed as a single callable used for all entries.</span>
<span class="sd">            hist_pref (str, Iterable[str]): Prefix all summaries in tensorboard with this string</span>
<span class="sd">            hist_prep (bool, Iterable[bool]): If True then dictionary variables will be prepended by the name of the dictionary</span>
<span class="sd">            fig (str, Iterable[str]): A modulo string of the form or ``&quot;{regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to add as tensorboard figures @ a particular logging frequency.</span>
<span class="sd">            fig_fn (Callable, Iterable[Callable]): Preprocess variable before logging to tensorboard into a plt.figure().</span>
<span class="sd">                If ``fig`` is a list then ``fig_fn`` can also be passed as list with a callable for each entry in</span>
<span class="sd">                ``fig`` or can be passed as a single callable used for all entries.</span>
<span class="sd">            fig_pref (str, Iterable[str]): Prefix all summaries in tensorboard with this string</span>
<span class="sd">            fig_prep (bool, Iterable[bool]): If True then dictionary variables will be prepended by the name of the dictionary</span>
<span class="sd">            txt (str): A modulo string of the form ``&quot;{regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to add as tensorboard text @ a particular logging frequency.</span>
<span class="sd">            txt_fn (Callable, Iterable[Callable]): Preprocess variable before logging to tensorboard.</span>
<span class="sd">                If ``txt`` is a list then ``txt_fn`` can also be passed as list with a callable for each entry in</span>
<span class="sd">                ``txt`` or can be passed as a single callable used for all entries.</span>
<span class="sd">            txt_pref (str, Iterable[str]): Prefix all summaries in tensorboard with this string</span>
<span class="sd">            txt_prep (bool, Iterable[bool]): If True then dictionary variables will be prepended by the name of the dictionary</span>
<span class="sd">            vid (str, Iterable[str]): A modulo string of the form ``&quot;{regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to add as tensorboard videos @ a particular logging frequency.</span>
<span class="sd">            vid_fn (Callable, Iterable[Callable]): Preprocess variable to a tensor of shape [B, T, C, H, W] before logging to tensorboard.</span>
<span class="sd">                If ``vid`` is a list then ``vid_fn`` can also be passed as list with a callable for each entry in</span>
<span class="sd">                ``vid`` or can be passed as a single callable used for all entries.</span>
<span class="sd">            vid_pref (str, Iterable[str]): Prefix all summaries in tensorboard with this string</span>
<span class="sd">            vid_prep (bool, Iterable[bool]): If True then dictionary variables will be prepended by the name of the dictionary</span>
<span class="sd">            msg (str, Iterable[str]): A modulo string of the form ``&quot;{regex}-&gt;{exp_regex}@{steps}s&quot;`` (or list of)</span>
<span class="sd">                giving the variables to log as messages with the experiments matching ``exp_regex``.</span>
<span class="sd">            msg_keep (str, Iterable[str]): One of [&#39;latest&#39;, &#39;max&#39;, &#39;min&#39;] giving the protocol to use on message collision</span>
<span class="sd">            msg_leader (str, Iterable[str]): A regex to a single variable. If supplied then this variable will be treated as the leader</span>
<span class="sd">                and all other variables will be logged only if the keep condition is met for the leader</span>
<span class="sd">            msg_expand (bool, Iterable[bool]): If True then dictionary variables with K keys will be expanded to give K variables</span>
<span class="sd">            msg_prep (bool, Iterable[bool]): If True then each variable in the dictionary will be prepended by the dictionary name.</span>
<span class="sd">            probe (str, Iterable[str]): A string of the form ``f&quot;{regex}@{steps}&quot;`` to log resource use to each</span>
<span class="sd">                experiment that matches regex (or list of for different triggers).</span>
<span class="sd">            limit (str): A modulo string of the form ``f&quot;@{modulo}{triger}&quot; used to limit the number of iterations of</span>
<span class="sd">                an experiment at a particular trigger level. This is useful if an experiment is restarted for</span>
<span class="sd">                example.</span>

<span class="sd">        Note:</span>
<span class="sd">            All variables  `..._fn`, `..._pref` and `..._prep` as well as ``ckpt_keep`` and ``msg_leader``,</span>
<span class="sd">            ``msg_expand`` and ``msg_prep`` can be supplied as a single or as a list of entries, one for each set of</span>
<span class="sd">            variables matching each modulo string in each case.</span>


<span class="sd">        Example 1::</span>

<span class="sd">            nn, opt, dataset = ..., ...</span>

<span class="sd">            m = Monitor(</span>
<span class="sd">                directory,</span>
<span class="sd">                checkpoint=(&#39;model@1e&#39;, &#39;opt@100s&#39;),   # Checkpoint the model once per epoch and opt every 100 steps</span>
<span class="sd">                log=&#39;^loss$@100s&#39;,   # Log the loss to stdout every 100 steps</span>
<span class="sd">                img=&#39;^x$@1000s&#39;, sca=(&#39;^loss$@100s&#39;, &#39;eval_.*@1e&#39;), time=(&#39;@100s&#39;)     # Log to tensorboard</span>
<span class="sd">                time=(&#39;@100s&#39;, ),   # Generate timing statistics every 100 steps</span>
<span class="sd">                hooks=[  # Custom hooks are also supported</span>
<span class="sd">                    MyVeryOwnHook(...)])</span>

<span class="sd">            # The only modification needed to the training loop are the em calls.</span>
<span class="sd">            # Nested loops corresponds to different triggers from inside out</span>
<span class="sd">            # we have [&quot;step&quot; or &quot;s&quot;, &quot;epoch&quot; or &quot;e&quot;, &quot;era&quot; or &quot;er&quot;, &quot;eon&quot; or &quot;eo&quot;, &quot;supereon&quot; or &quot;se&quot;]</span>
<span class="sd">            for epoch in m(range(10)):</span>
<span class="sd">                for x, y in m(datset):</span>
<span class="sd">                    _y_ = model(x)</span>
<span class="sd">                    opt.zero_grad()</span>
<span class="sd">                    loss = loss_fn(y, _y_)</span>
<span class="sd">                    loss.backward()</span>
<span class="sd">                    loss.step()</span>
<span class="sd">                    em.log(&#39;Manual Logging is also supported&#39;)</span>
<span class="sd">                eval_1, eval_2 = eval(model, ds)</span>

<span class="sd">            # Steps and epoch have been incremented</span>
<span class="sd">            assert em.step == len(ds) * 10</span>
<span class="sd">            assert em.epoch == 10</span>

<span class="sd">            # Lets reload the model at the 5th epoch</span>
<span class="sd">            em.load(step=5*len(ds), model)</span>
<span class="sd">            # The step and epoch will be updated</span>
<span class="sd">            print(em.step, em.epoch)</span>

<span class="sd">        Example 2::</span>

<span class="sd">            from xmen.monitor import Monitor</span>
<span class="sd">            import numpy as np</span>
<span class="sd">            import torch</span>
<span class="sd">            import os</span>
<span class="sd">            import matplotlib.pyplot as plt</span>
<span class="sd">            from torchvision.datasets.mnist import MNIST</span>
<span class="sd">            from torch.utils.data import DataLoader</span>
<span class="sd">            import torchvision.transforms as T</span>

<span class="sd">            plt.style.use(&#39;ggplot&#39;)</span>
<span class="sd">            ds = DataLoader(MNIST(os.getenv(&quot;HOME&quot;) + &#39;/data/mnist&#39;, download=True,</span>
<span class="sd">                  transform=T.Compose(</span>
<span class="sd">                      [T.Resize([64, 64]), T.CenterCrop([64, 64]),</span>
<span class="sd">                       T.ToTensor(), T.Normalize([0.5], [0.5])])), 8)</span>

<span class="sd">            m = Monitor(</span>
<span class="sd">                directory=&#39;/tmp/tb_5&#39;,</span>
<span class="sd">                sca=[&#39;^z$|^X$@10s&#39;, &#39;^a|^x$@5s&#39;],</span>
<span class="sd">                img=[&#39;^mnist@10s&#39;, &#39;^mnist@5s&#39;], img_fn=[lambda x: x[:2], lambda x: x[:5]], img_pref=[&#39;2&#39;, &#39;5&#39;],</span>
<span class="sd">                hist=&#39;Z@1s&#39;,</span>
<span class="sd">                fig=&#39;fig@10s&#39;,</span>
<span class="sd">                txt=&#39;i@5s&#39;, txt_fn=lambda x: f&#39;Hello at step {x}&#39;,</span>
<span class="sd">                vid=&#39;^mnist@10s&#39;, vid_fn=lambda x: (x.unsqueeze(0) - x.min()) / (x.max() - x.min())</span>
<span class="sd">            )</span>

<span class="sd">            # variables</span>
<span class="sd">            x = 0.</span>
<span class="sd">            a = [1, 2]</span>
<span class="sd">            z = {&#39;x&#39;: 5, &#39;y&#39;: 10}</span>
<span class="sd">            for i, (mnist, _) in m(zip(range(31), ds)):</span>
<span class="sd">                # plot a figure</span>
<span class="sd">                fig = plt.figure(figsize=[10, 5])</span>
<span class="sd">                plt.plot(np.linspace(0, 1000), np.cos(np.linspace(0, 1000) * i))</span>
<span class="sd">                # random tensor</span>
<span class="sd">                Z = torch.randn([10, 3, 64, 64]) * i / 100</span>
<span class="sd">                # scalars</span>
<span class="sd">                x = (i - 15) ** 2</span>
<span class="sd">                z[&#39;i&#39;] = i</span>
<span class="sd">                z[&#39;x&#39;] += 1</span>
<span class="sd">                z[&#39;y&#39;] = z[&#39;x&#39;] ** 2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">hooks</span><span class="o">=</span><span class="n">hooks</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">log_fn</span><span class="o">=</span><span class="n">log_fn</span><span class="p">,</span> <span class="n">log_format</span><span class="o">=</span><span class="n">log_format</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                         <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg_keep</span><span class="o">=</span><span class="n">msg_keep</span><span class="p">,</span> <span class="n">msg_leader</span><span class="o">=</span><span class="n">msg_leader</span><span class="p">,</span> <span class="n">msg_expand</span><span class="o">=</span><span class="n">msg_expand</span><span class="p">,</span> <span class="n">msg_prep</span><span class="o">=</span><span class="n">msg_prep</span><span class="p">,</span>
                         <span class="n">probe</span><span class="o">=</span><span class="n">probe</span><span class="p">,</span>
                         <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>

        <span class="c1"># -- Add modulo hooks to hooks</span>
        <span class="k">if</span> <span class="n">ckpt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ckpt</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">ckpt</span> <span class="o">=</span> <span class="p">[</span><span class="n">ckpt</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ckpt_keep</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">ckpt_keep</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">ckpt_keep</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ckpt</span><span class="p">))</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;Either one fn, pref and prep or one for each &#39;</span><span class="si">{ckpt_keep}</span><span class="s2">&#39; must be set&quot;</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ckpt</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ckpt_keep</span><span class="p">,</span> <span class="p">)),</span> <span class="n">warn</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ckpt</span><span class="p">,</span> <span class="n">ckpt_keep</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Checkpointer</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">to_keep</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>

        <span class="c1"># tensorboard summaries</span>
        <span class="n">kinds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sca&#39;</span><span class="p">:</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;hist&#39;</span><span class="p">:</span> <span class="s1">&#39;histogram&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;fig&#39;</span><span class="p">:</span> <span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;vid&#39;</span><span class="p">:</span> <span class="s1">&#39;video&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">:</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;img&#39;</span><span class="p">:</span>
                    <span class="n">options</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_options&#39;</span><span class="p">]</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_fn&#39;</span><span class="p">]</span>
                <span class="n">pref</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_pref&#39;</span><span class="p">]</span>
                <span class="n">prep</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_prep&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">kind</span> <span class="o">=</span> <span class="p">[</span><span class="n">kind</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">fn</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kind</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pref</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">pref</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">pref</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kind</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">prep</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">prep</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">kind</span><span class="p">))</span>
                <span class="n">warn</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;Either one fn, pref and prep or one for each &#39;</span><span class="si">{kind}</span><span class="s2">&#39; must be set&quot;</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">pref</span><span class="p">,</span> <span class="n">prep</span><span class="p">)),</span> <span class="n">warn</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">pre</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">pref</span><span class="p">,</span> <span class="n">prep</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TensorboardLogger</span><span class="p">(</span><span class="n">kinds</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">c</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">pr</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span> <span class="o">=</span> <span class="n">Checkpointer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="n">to_keep</span><span class="o">=</span><span class="n">ckpt_keep</span><span class="p">)</span></div>

<div class="viewcode-block" id="TorchMonitor.checkpoint"><a class="viewcode-back" href="../../api.html#xmen.monitor.TorchMonitor.checkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checkpoint the torch.nn objects with step and epoch passed as ``name==variable_to_save``&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="TorchMonitor.load"><a class="viewcode-back" href="../../api.html#xmen.monitor.TorchMonitor.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attempt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_triggers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">modules</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the torch torch.nn objects passed as name=variable_to_load,</span>
<span class="sd">        from the directory and reset the state of the em (if update_triggers == True). If attempt == False then an</span>
<span class="sd">        Exception will be raised if either the directory does not contain checkpoints corresponding to modules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;WARNING: Cannot load as monitor does not have a directory&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;checkpoints&#39;</span><span class="p">)</span>

        <span class="n">modules</span><span class="p">,</span> <span class="n">triggers</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span><span class="p">,</span> <span class="o">**</span><span class="n">modules</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_triggers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">triggers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">modules</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Rob Weston.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.2.3',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/language_data.js"></script>
      <script type="text/javascript" src="../../_static/jquery.fancybox.min.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
  <script type="text/javascript">
    $(function(){
      $('.image-reference').fancybox();
    })
  </script>

</body>
</html>